---
# yamllint disable rule:line-length
name: CI

"on":
  push:
    branches: "main"
  pull_request:
    branches: "main"

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
        with:
          enable-cache: true
          python-version:
            "3.14"
            # Avoid post-job cache pruning failures on self-hosted runners
            # Keep pruning on GitHub-hosted runners
          prune-cache: ${{ runner.environment == 'github-hosted' }}
      - name: Install Python 3.14 with uv
        run: uv python install 3.14
      - run: uv sync --group dev --frozen
      - name: Cache pre-commit
        if: ${{ runner.environment == 'github-hosted' }}
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.cache/pre-commit
          key: >-
            pre-commit-${{ runner.os }}-${{
            hashFiles('.pre-commit-config.yaml') }}
          restore-keys: pre-commit-${{ runner.os }}-
      - run: uv run pre-commit run --all-files
        env:
          SKIP: eslint-webui,ensure-webui-deps
      - name: Type check (mypy)
        run: uv run mypy

  test:
    needs: [lint]
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
        with:
          enable-cache: true
          python-version:
            ${{ matrix.python-version }}
            # Avoid post-job cache pruning failures on self-hosted runners
            # Keep pruning on GitHub-hosted runners
          prune-cache: ${{ runner.environment == 'github-hosted' }}
      - name: Install Python ${{ matrix.python-version }} with uv
        run: uv python install ${{ matrix.python-version }}
      - run: uv sync --group test --frozen
        shell: bash
      - run: uv run pytest
        shell: bash

  webui:
    runs-on: ubuntu-latest
    needs: [lint]
    env:
      # If npm misses optional rollup native bins, fall back to the pure JS build.
      ROLLUP_USE_PURE_JS: "true"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: packages/recozik-webui/package-lock.json
      - name: Install dependencies
        run: |
          cd packages/recozik-webui
          npm ci --include=optional
      - name: Lint frontend
        run: |
          cd packages/recozik-webui
          npm run lint
      - name: Test frontend
        run: |
          cd packages/recozik-webui
          npm test -- --run
      - name: Build frontend
        run: |
          cd packages/recozik-webui
          npm run build

  webui-e2e:
    runs-on: ubuntu-latest
    needs: [webui]
    env:
      # If npm misses optional rollup native bins, fall back to the pure JS build.
      ROLLUP_USE_PURE_JS: "true"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: packages/recozik-webui/package-lock.json
      - name: Install dependencies
        run: |
          cd packages/recozik-webui
          npm ci --include=optional
      - name: Cache Playwright browsers
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('packages/recozik-webui/package-lock.json') }}
          restore-keys: playwright-${{ runner.os }}-
      - name: Install Playwright browsers
        run: |
          cd packages/recozik-webui
          npx playwright install --with-deps chromium
      - name: Run E2E tests
        env:
          PORT: 3000
          BASE_URL: http://localhost:3000
          NEXT_PUBLIC_RECOZIK_API_BASE: http://localhost:9999/api
          RECOZIK_WEB_API_BASE: http://localhost:9999/api
          RECOZIK_INTERNAL_API_BASE: http://localhost:9999/api
          MOCK_API_PORT: 9999
          VISUAL_SNAPSHOTS: "0"
        run: |
          cd packages/recozik-webui
          node tests/e2e/mock-api-server.js &
          MOCK_PID=$!
          npx wait-on http://localhost:9999/health
          trap "kill $MOCK_PID" EXIT
          npm run build
          npx playwright test --reporter=line --project=chromium

  all-checks:
    name: All Checks
    needs: [lint, test, webui, webui-e2e]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: All's green?
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # v1.2.2
        with:
          jobs: ${{ toJSON(needs) }}
