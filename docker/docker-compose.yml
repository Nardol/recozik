version: "3.9"

services:
  backend:
    hostname: backend
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    environment:
      RECOZIK_WEB_BASE_MEDIA_ROOT: /data
      RECOZIK_WEB_UPLOAD_SUBDIR: uploads
      RECOZIK_WEB_ADMIN_TOKEN: ${RECOZIK_ADMIN_TOKEN:-dev-admin}
      RECOZIK_WEB_ACOUSTID_API_KEY: ${RECOZIK_ACOUSTID_API_KEY:-demo-key}
      RECOZIK_WEB_AUDD_TOKEN: ${RECOZIK_AUDD_TOKEN:-}
    volumes:
      - recozik-data:/data

  frontend:
    hostname: frontend
    build:
      context: ..
      dockerfile: docker/frontend.Dockerfile
    environment:
      NEXT_PUBLIC_RECOZIK_API_BASE: /api
    depends_on:
      - backend

  nginx:
    hostname: nginx
    image: docker.io/library/nginx:1.27
    profiles: ["reverse-proxy"]
    depends_on:
      - backend
      - frontend
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"

volumes:
  recozik-data:
