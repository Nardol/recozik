---
services:
  backend:
    hostname: backend
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    environment:
      RECOZIK_WEB_BASE_MEDIA_ROOT: ${RECOZIK_WEB_BASE_MEDIA_ROOT:-/data}
      RECOZIK_WEB_UPLOAD_SUBDIR: ${RECOZIK_WEB_UPLOAD_SUBDIR:-uploads}
      RECOZIK_WEB_ADMIN_TOKEN: ${RECOZIK_ADMIN_TOKEN:-dev-admin}
      RECOZIK_WEB_ADMIN_USERNAME: ${RECOZIK_WEB_ADMIN_USERNAME:-admin}
      RECOZIK_WEB_ADMIN_PASSWORD: ${RECOZIK_WEB_ADMIN_PASSWORD:-dev-password}
      RECOZIK_WEB_PRODUCTION_MODE: ${RECOZIK_WEB_PRODUCTION_MODE:-false}
      RECOZIK_WEB_ACOUSTID_API_KEY: ${RECOZIK_ACOUSTID_API_KEY:-demo-key}
      RECOZIK_WEB_AUDD_TOKEN: ${RECOZIK_AUDD_TOKEN:-}
    volumes:
      - recozik-data:/data

  frontend:
    hostname: frontend
    build:
      context: ..
      dockerfile: docker/frontend.Dockerfile
      args:
        RECOZIK_WEBUI_UPLOAD_LIMIT: ${RECOZIK_WEBUI_UPLOAD_LIMIT:-100mb}
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    environment:
      NEXT_PUBLIC_RECOZIK_API_BASE: /api
      RECOZIK_WEBUI_UPLOAD_LIMIT: ${RECOZIK_WEBUI_UPLOAD_LIMIT:-100mb}
    depends_on:
      backend:
        condition: service_healthy

  # Start nginx via `docker compose --profile reverse-proxy up`
  nginx:
    hostname: nginx
    image: docker.io/library/nginx:1.29
    profiles: ["reverse-proxy"]
    depends_on:
      - backend
      - frontend
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"

volumes:
  recozik-data:
